{% extends 'base/base.html' %}
{% load static %}

{% block title %}Yuz ma’lumotlari – Boshqaruv paneli{% endblock %}

{% block styles %}
<link href="{% static 'assets/libs/sweetalert2/sweetalert2.min.css' %}" rel="stylesheet">
<link href="{% static 'assets/libs/jquery-toast-plugin/jquery.toast.min.css' %}" rel="stylesheet">
<link href="{% static 'assets/libs/datatables/datatables.min.css' %}" rel="stylesheet">

<style>
.progress-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(5px);
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    z-index: 9999;
    color: white;
}
.progress-overlay.show { display: flex; }
.progress-circle {
    width: 80px;
    height: 80px;
    border: 6px solid #374151;
    border-top-color: #4361ee;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.table td, .table th { vertical-align: middle; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    {% include 'includes/breadcrumbs.html' %}

    <div id="progress-overlay" class="progress-overlay">
        <div class="progress-circle"></div>
        <div class="fw-semibold fs-5 mt-3" id="progress-text">Jarayon boshlanmoqda...</div>
        <div class="small" id="progress-subtext">Iltimos, kuting</div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow rounded-3">
                <div class="card-body">
                    <!-- Action Buttons -->
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button id="generate-students-btn" class="btn btn-success btn-sm d-flex align-items-center gap-1">
                            <i class="mdi mdi-account-multiple-plus-outline"></i> Talabalar uchun yaratish
                        </button>
                        <button id="generate-employees-btn" class="btn btn-primary btn-sm d-flex align-items-center gap-1">
                            <i class="mdi mdi-account-tie-outline"></i> Xodimlar uchun yaratish
                        </button>
                        <button id="clear-all-encodings" class="btn btn-outline-danger btn-sm d-flex align-items-center gap-1">
                            <i class="mdi mdi-delete-sweep-outline"></i> Barchasini tozalash
                        </button>
                    </div>

                    <!-- Filter Form -->
                    <form method="get" class="d-flex flex-wrap gap-2 align-items-center mb-3">
                        <input type="text" name="q" class="form-control form-control-sm"
                               placeholder="Ism, ID, email..." value="{{ search_query }}" style="min-width:120px; max-width:250px;">
                        <select name="role" class="form-select form-select-sm" onchange="this.form.submit()" style="min-width:120px; max-width:180px;">
                            <option value="">Barcha foydalanuvchilar</option>
                            <option value="student" {% if current_role == 'student' %}selected{% endif %}>Talabalar</option>
                            <option value="employee" {% if current_role == 'employee' %}selected{% endif %}>Xodimlar</option>
                            <option value="superadmin" {% if current_role == 'superadmin' %}selected{% endif %}>Superadminlar</option>
                        </select>
                        <button type="submit" class="btn btn-secondary btn-sm">Filtrlash</button>
                        {% if search_query or current_role %}
                        <a href="{% url 'face_encodings_list' %}" class="btn btn-outline-secondary btn-sm">Tozalash</a>
                        {% endif %}
                    </form>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-hover align-middle text-center mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Rasm</th>
                                    <th>Foydalanuvchi</th>
                                    <th>Rol</th>
                                    <th>ID raqami</th>
                                    <th>Encoding</th>
                                    <th>Yaratilgan</th>
                                    <th>Amal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in page_obj %}
                                <tr>
                                    <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                                    <td>
                                        {% if item.user.image %}
                                        <img src="{{ item.user.image.url }}" class="rounded-circle border border-light" width="40" height="40"
                                             onerror="this.src='{% static 'assets/images/users/default-avatar.png' %}'">
                                        {% else %}
                                        <i class="mdi mdi-account-circle mdi-36px text-muted"></i>
                                        {% endif %}
                                    </td>
                                    <td class="text-start">
                                        <div class="fw-medium">{{ item.user.full_name|default:item.user.username|truncatechars:18 }}</div>
                                        <small class="text-muted">{{ item.user.email|default:"—" }}</small>
                                    </td>
                                    <td>
                                        {% if item.user.role == 'student' %}
                                            <span class="badge bg-success-subtle text-success px-2 py-1">Talaba</span>
                                        {% elif item.user.role == 'employee' %}
                                            <span class="badge bg-primary-subtle text-primary px-2 py-1">Xodim</span>
                                        {% elif item.user.is_superuser %}
                                            <span class="badge bg-dark-subtle text-dark px-2 py-1">Superadmin</span>
                                        {% endif %}
                                    </td>
                                    <td><code class="small">{{ item.user.student_id_number|default:item.user.employee_id_number|default:"—" }}</code></td>
                                    <td>
                                        {% if item.encoding_data %}
                                            <span class="badge bg-success-subtle text-success px-2 py-1">Bor</span>
                                        {% else %}
                                            <span class="badge bg-danger-subtle text-danger px-2 py-1">Yo‘q</span>
                                        {% endif %}
                                    </td>
                                    <td class="small text-muted">{{ item.created_at|date:"d.m.Y H:i" }}</td>
                                    <td>
                                        {% if item.encoding_data %}
                                            <button type="button" class="btn btn-danger-subtle btn-icon btn-sm rounded-circle delete-single" data-id="{{ item.id }}" title="O‘chirish">
                                                <i class="mdi mdi-delete"></i>
                                            </button>
                                        {% else %}
                                            <button type="button" class="btn btn-success-subtle btn-icon btn-sm rounded-circle generate-single" data-id="{{ item.user.id }}" data-role="{{ item.user.role }}" title="Yaratish">
                                                <i class="mdi mdi-creation"></i>
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="mdi mdi-emoticon-sad-outline display-6 d-block mb-2"></i>
                                        Hech qanday ma'lumot topilmadi
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <br>
                                  {% if page_obj %}
                        <ul class="pagination pagination-rounded justify-content-end mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">«</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">«</span></li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                {% if num == page_obj.number %}
                                    <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">»</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">»</span></li>
                            {% endif %}
                        </ul>
                        {% endif %}
                    </div>


                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'assets/libs/sweetalert2/sweetalert2.min.js' %}"></script>
<script src="{% static 'assets/libs/jquery-toast-plugin/jquery.toast.min.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const overlay = document.getElementById('progress-overlay');
    const progressText = document.getElementById('progress-text');
    const progressSubtext = document.getElementById('progress-subtext');

    const showProgress = (main = 'Jarayon boshlanmoqda...', sub = 'Iltimos, kuting') => {
        progressText.textContent = main;
        progressSubtext.textContent = sub;
        overlay.classList.add('show');
    };
    const hideProgress = () => overlay.classList.remove('show');

    // WebSocket connection
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = wsScheme + "://" + window.location.host + "/ws/face-encoding/";
    const socket = new WebSocket(wsUrl);

    socket.onopen = () => console.log("WebSocket connected.");
    socket.onclose = () => console.log("WebSocket disconnected.");
    socket.onerror = e => console.error("WebSocket error:", e);

    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.status === "ok") {
            progressText.textContent = `User ID ${data.user_id} encoding yaratildi (${data.progress})`;
            $.toast({ heading: 'Muvaffaqiyat!', text: `User ID ${data.user_id} encoding yaratildi`, icon: 'success', position: 'top-right', stack: 3 });
        } else if (data.status === "skipped") {
            progressText.textContent = `User ID ${data.user_id} da rasm yo‘q (${data.progress})`;
        } else if (data.status === "error") {
            progressText.textContent = `Xato User ID ${data.user_id} (${data.progress})`;
            $.toast({ heading: 'Xato!', text: `User ID ${data.user_id || ''}: ${data.error}`, icon: 'error', position: 'top-right', stack: 3 });
        } else if (data.status === "done") {
            progressText.textContent = "Barcha encodinglar tugadi";
            $.toast({ heading: 'Tugadi', text: `Barcha encodinglar yaratildi`, icon: 'success', position: 'top-right', stack: 3 });
            hideProgress();
            setTimeout(() => location.reload(), 1500);
        }
    };

    const sendWS = (payload, progressMain, progressSub) => {
        showProgress(progressMain, progressSub);
        socket.send(JSON.stringify(payload));
    };

    document.getElementById('generate-students-btn').onclick = () => sendWS(
        { action: 'generate_all', role: 'student' },
        "Talabalar uchun encoding yaratilmoqda...",
        "Iltimos kuting"
    );

    document.getElementById('generate-employees-btn').onclick = () => sendWS(
        { action: 'generate_all', role: 'employee' },
        "Xodimlar uchun encoding yaratilmoqda...",
        "Iltimos kuting"
    );

    document.querySelectorAll('.generate-single').forEach(btn => {
        btn.onclick = () => sendWS(
            { action: 'generate_single', user_id: parseInt(btn.dataset.id) },
            "Yuz encoding yaratilmoqda...",
            "Iltimos kuting"
        );
    });

    document.querySelectorAll('.delete-single').forEach(btn => {
        btn.onclick = async () => {
            const confirm = await Swal.fire({
                title: 'Tasdiqlang',
                text: "Yuz encoding o‘chiriladi. Davom etasizmi?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ha',
                cancelButtonText: 'Bekor qilish',
                reverseButtons: true,
                customClass: { confirmButton: 'btn btn-danger me-2', cancelButton: 'btn btn-outline-secondary' },
                buttonsStyling: false
            });
            if (!confirm.isConfirmed) return;

            showProgress("Encoding o‘chirilmoqda...", "Iltimos kuting");

            try {
                const res = await fetch(`/users/face-encodings/delete/${btn.dataset.id}/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': document.cookie.split('; ').find(c => c.startsWith('csrftoken='))?.split('=')[1] || '' },
                    credentials: 'same-origin'
                });
                const data = await res.json();
                if (data.success) {
                    $.toast({ heading: 'Muvaffaqiyat!', text: "Encoding o‘chirildi", icon: 'success', position: 'top-right', stack: 3 });
                    setTimeout(() => location.reload(), 1000);
                } else throw new Error(data.error || "Xato yuz berdi");
            } catch (err) {
                $.toast({ heading: 'Xato!', text: err.message, icon: 'error', position: 'top-right', stack: 3 });
            } finally {
                hideProgress();
            }
        };
    });

});
</script>
{% endblock %}
