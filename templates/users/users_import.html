{% extends 'base/base.html' %}
{% load static %}

{% block title %}
HEMIS dan foydalanuvchilarni yuklash
{% endblock title %}

{% block styles %}
<link href="{% static 'assets/libs/select2/css/select2.min.css' %}" rel="stylesheet" type="text/css"/>
<link href="{% static 'assets/libs/dropzone/min/dropzone.min.css' %}" rel="stylesheet" type="text/css"/>
<link href="{% static 'assets/libs/quill/quill.core.css' %}" rel="stylesheet" type="text/css"/>
<link href="{% static 'assets/libs/quill/quill.snow.css' %}" rel="stylesheet" type="text/css"/>
<!-- jQuery Toast css -->
<link href="{% static 'assets/libs/jquery-toast-plugin/jquery.toast.min.css' %}" rel="stylesheet" type="text/css"/>
{% endblock styles %}

{% block content %}
<div class="container-fluid">

    <!-- === Breadcrumb === -->
    {% include 'includes/breadcrumbs.html' %}

    <!-- === Yuklash formalar === -->
    <div class="row">
        <!-- === Hodimlarni yuklash === -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-dark">
                        <i class="mdi mdi-account-tie-outline text-danger me-2"></i> Hodimlarni yuklash
                    </h5>
                </div>
                <div class="card-body">
                    <form id="staff-form">
                        <!-- Tanlov turi -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Yuklash turi</label>
                            <select id="staff-type" class="form-select">
                                <option value="all">Barchasi</option>
                                <option value="department">Boâ€˜lim boâ€˜yicha</option>
                            </select>
                        </div>

                        <!-- Boâ€˜lim tanlash -->
                        <div class="mb-3" id="department-select" style="display:none;">
                            <label class="form-label fw-semibold">Boâ€˜limni tanlang</label>
                            <select id="department-list" class="form-select">
                                <option value="">Yuklanmoqda...</option>
                            </select>
                        </div>

                        <!-- Tugmalar -->
                        <div class="text-end d-flex justify-content-end gap-2">
                            <!-- ðŸ”¹ Oâ€˜chirish tugmasi -->
                            <button type="button" id="clear-staff-btn" class="btn btn-outline-secondary waves-effect">
                                <i class="mdi mdi-delete-outline"></i> Tozalash
                            </button>

                            <!-- ðŸ”¹ Yuklash tugmasi -->
                            <button type="submit" class="btn btn-danger waves-effect waves-light">
                                <i class="mdi mdi-upload"></i> <span class="btn-text">Yuklash</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- === Talabalarni yuklash === -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-dark">
                        <i class="mdi mdi-school-outline text-success me-2"></i> Talabalarni yuklash
                    </h5>
                </div>
                <div class="card-body">
                    <form>
                        <!-- Tanlov turi -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Yuklash turi</label>
                            <select id="student-type" class="form-select">
                                <option value="all">Barchasi</option>
                                <option value="group">Akademik guruh boâ€˜yicha</option>
                            </select>
                        </div>

                        <!-- Guruh tanlash -->
                        <div class="mb-3" id="group-select" style="display:none;">
                            <label class="form-label fw-semibold">Akademik guruhni tanlang</label>
                            <select id="group-list" class="form-select" style="width: 100%;">
                                <option value="">Tanlang...</option>
                            </select>
                        </div>

                        <!-- Tugmalar -->
                        <div class="text-end d-flex justify-content-end gap-2">
                            <!-- Tozalash tugmasi -->
                            <button type="button" id="clear-students-btn" class="btn btn-outline-danger waves-effect">
                                <i class="mdi mdi-delete-outline"></i> Tozalash
                            </button>

                            <!-- Yuklash tugmasi -->
                            <button type="button" id="upload-students-btn"
                                    class="btn btn-success waves-effect waves-light">
                                <i class="mdi mdi-upload"></i> Yuklash
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div> <!-- end row -->


    <!-- === Statistik ma'lumotlar === -->
    <div class="row mt-4">
        <!-- === Hodimlar statistikasi === -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h5 class="mb-0 text-dark">
                        <i class="mdi mdi-account-multiple-outline text-danger me-2"></i>
                        Hodimlar statistikasi
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-semibold">Umumiy hodimlar soni:</span>
                        <span class="badge bg-danger rounded-pill px-3 py-2 fs-6">{{ staff_count|default:125 }}</span>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle mb-0">
                            <thead class="table-light">
                            <tr>
                                <th>Boâ€˜lim</th>
                                <th class="text-end">Hodimlar soni</th>
                            </tr>
                            </thead>
                            <!-- === Hodimlar statistikasi === -->
                            <tbody>
                            {% for stat in staff_stats %}
                            <tr>
                                <td>{{ stat.department_name|default:"Boâ€˜lim nomi yoâ€˜q" }}</td>
                                <td class="text-end">{{ stat.count }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2" class="text-center text-muted">Hodimlar hali yuklanmagan</td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- === Talabalar statistikasi === -->
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h5 class="mb-0 text-dark">
                        <i class="mdi mdi-account-group-outline text-success me-2"></i>
                        Talabalar statistikasi
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-semibold">Umumiy talabalar soni:</span>
                        <span class="badge bg-success rounded-pill px-3 py-2 fs-6">{{ student_count|default:2300 }}</span>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle mb-0">
                            <thead class="table-light">
                            <tr>
                                <th>Akademik guruh</th>
                                <th class="text-end">Talabalar soni</th>
                            </tr>
                            </thead>
                            <!-- === Talabalar statistikasi === -->
                            <tbody>
                            {% for stat in student_stats %}
                            <tr>
                                <td>{{ stat.group_name|default:"Guruh nomi yoâ€˜q" }}</td>
                                <td class="text-end">{{ stat.count }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2" class="text-center text-muted">Talabalar hali yuklanmagan</td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- end statistik row -->

</div> <!-- end container-fluid -->

<!-- Loader overlay -->
<div id="global-loader"
     class="position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-90 d-flex align-items-center justify-content-center flex-column d-none"
     style="z-index: 9999;">
    <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;"></div>
    <div class="progress w-50" style="height: 8px;">
        <div id="progress-bar" class="progress-bar bg-danger" style="width: 0%;"></div>
    </div>
    <p id="progress-text" class="mt-3 text-dark fw-semibold">Tayyorlanmoqda...</p>
</div>

{% endblock content %}

{% block scripts %}
<script src="{% static 'assets/libs/select2/js/select2.min.js' %}"></script>
<script src="{% static 'assets/libs/jquery-toast-plugin/jquery.toast.min.js' %}"></script>
<script src="{% static 'assets/js/pages/toastr.init.js' %}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // CSRF token olish
        const getCookie = (name) => {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        };
        const csrftoken = getCookie('csrftoken');

        // Global elementlar
        const globalLoader = document.getElementById('global-loader');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');

        // Progressni yangilash funksiyasi
        const updateProgress = (percent, text = null) => {
            progressBar.style.width = `${percent}%`;
            progressText.textContent = text || `${percent}%`;
        };

        // Soxta progress (real progress kelguncha)
        let fakeProgressInterval = null;
        const startFakeProgress = () => {
            let fake = 0;
            fakeProgressInterval = setInterval(() => {
                if (fake < 85) {
                    fake += 3 + Math.random() * 5;
                    updateProgress(Math.min(fake, 85));
                }
            }, 400);
        };

        const stopFakeProgress = () => {
            if (fakeProgressInterval) clearInterval(fakeProgressInterval);
        };

        // Progressni real vaqtda yangilash (polling)
        let progressPolling = null;
        const startProgressPolling = (type, onComplete) => {
            progressPolling = setInterval(() => {
                fetch(`/users/get-sync-progress/?type=${type}`)
                    .then(r => r.json())
                    .then(data => {
                        const percent = data.percent || 0;
                        const status = data.status;

                        stopFakeProgress();
                        updateProgress(percent, `${data.processed}/${data.total} (${percent}%)`);

                        if (status === 'completed' || status === 'error') {
                            clearInterval(progressPolling);
                            if (onComplete) onComplete(data);
                        }
                    })
                    .catch(() => {
                        updateProgress(0, 'Ulanib boâ€˜lmadi');
                    });
            }, 1200);
        };

        // =====================
        // HODIMLAR (Boâ€˜limlar)
        // =====================
        const staffType = document.getElementById('staff-type');
        const departmentSelectDiv = document.getElementById('department-select');
        const $departmentList = $('#department-list');
        const staffForm = document.getElementById('staff-form');

        // Select2: Boâ€˜limlar
        $departmentList.select2({
            placeholder: "Boâ€˜limni tanlang yoki qidiring...",
            width: '100%',
            allowClear: true,
            language: {noResults: () => "Topilmadi", searching: () => "Qidirilmoqda..."}
        });

        const loadDepartments = () => {
            $departmentList.empty().append(new Option("Yuklanmoqda...", "loading", true, true)).prop('disabled', true).trigger('change');

            fetch('/users/get-specialties/')
                .then(r => r.ok ? r.json() : Promise.reject(`HTTP ${r.status}`))
                .then(data => {
                    $departmentList.empty().prop('disabled', false);
                    const deps = data.departments || data.specialties || [];

                    if (data.error || deps.length === 0) {
                        $departmentList.append(new Option(data.error || "Boâ€˜lim topilmadi", "error"));
                    } else {
                        deps.forEach(d => $departmentList.append(new Option(d.name || "Nomsiz", d.id)));
                    }
                    $departmentList.trigger('change');
                })
                .catch(() => {
                    $departmentList.empty().append(new Option("Server xatosi", "error")).prop('disabled', false).trigger('change');
                });
        };

        staffType.addEventListener('change', () => {
            departmentSelectDiv.style.display = staffType.value === 'department' ? 'block' : 'none';
            if (staffType.value === 'department' && $departmentList.find('option').length <= 1) {
                loadDepartments();
            }
        });

        staffForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalHTML = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Boshlanmoqda...';

            const departmentId = staffType.value === 'department' ? $departmentList.val() : null;

            globalLoader.classList.remove('d-none');
            updateProgress(0, 'Boshlanmoqda...');
            startFakeProgress();

            fetch('/users/sync-employees/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
                body: JSON.stringify({department_id: departmentId})
            })
                .then(r => r.json())
                .then(data => {
                    stopFakeProgress();
                    if (data.success) {
                        startProgressPolling('employees', (final) => {
                            updateProgress(100, final.message);
                            $.toast({heading: 'Muvaffaqiyat', text: final.message, icon: 'success'});
                            setTimeout(() => location.reload(), 1500);
                        });
                    } else {
                        throw new Error(data.error || 'NomaÊ¼lum xato');
                    }
                })
                .catch(err => {
                    stopFakeProgress();
                    updateProgress(0, 'Xato: ' + err.message);
                    $.toast({heading: 'Xato', text: err.message, icon: 'error'});
                })
                .finally(() => {
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalHTML;
                    }, 1000);
                });
        });

        // =====================
        // TALABALAR (Guruhlar)
        // =====================
        const studentTypeSelect = document.getElementById('student-type');
        const groupSelectDiv = document.getElementById('group-select');
        const $groupList = $('#group-list');
        const loadStudentsBtn = document.querySelector('.btn-success.waves-effect');

        // Select2: Guruhlar (AJAX)
        $groupList.select2({
            placeholder: "Guruhni qidiring...",
            width: '100%',
            allowClear: true,
            minimumInputLength: 0,
            language: {noResults: () => "Topilmadi", searching: () => "Qidirilmoqda..."},
            ajax: {
                url: '/users/get-groups/',
                dataType: 'json',
                delay: 300,
                data: params => ({search: params.term || ''}),
                processResults: data => ({
                    results: (data.groups || []).map(g => ({id: g.id, text: g.name}))
                }),
                cache: true
            }
        });

        studentTypeSelect.addEventListener('change', () => {
            groupSelectDiv.style.display = studentTypeSelect.value === 'group' ? 'block' : 'none';
            if (studentTypeSelect.value !== 'group') $groupList.val(null).trigger('change');
        });

        loadStudentsBtn.addEventListener('click', function () {
            const type = studentTypeSelect.value;
            const groupId = $groupList.val();

            if (type === 'group' && !groupId) {
                alert("Iltimos, guruhni tanlang!");
                return;
            }

            const originalHTML = this.innerHTML;
            this.disabled = true;
            this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Yuklanmoqda...';

            globalLoader.classList.remove('d-none');
            updateProgress(0, 'Boshlanmoqda...');
            startFakeProgress();

            fetch('/users/sync-students/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
                body: JSON.stringify({type: type, group_id: groupId})
            })
                .then(r => r.json())
                .then(data => {
                    stopFakeProgress();
                    if (data.success) {
                        startProgressPolling('students', (final) => {
                            updateProgress(100, final.message);
                            $.toast({heading: 'Muvaffaqiyat', text: final.message, icon: 'success'});
                            setTimeout(() => location.reload(), 1500);
                        });
                    } else {
                        throw new Error(data.error || 'Yuklashda xato');
                    }
                })
                .catch(err => {
                    stopFakeProgress();
                    updateProgress(0, 'Xato: ' + err.message);
                    $.toast({heading: 'Xato', text: err.message, icon: 'error'});
                })
                .finally(() => {
                    setTimeout(() => {
                        this.disabled = false;
                        this.innerHTML = originalHTML;
                    }, 1000);
                });
        });

        // =====================
        // HODIMLARNI TOZALASH
        // =====================
        document.getElementById('clear-staff-btn').addEventListener('click', function () {
            if (!confirm('Barcha hodimlar oâ€˜chiriladi. Davom etasizmi?')) return;

            const originalHTML = this.innerHTML;
            this.disabled = true;
            this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Oâ€˜chirilmoqda...';

            fetch('/users/clear-employees/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken}
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        $.toast({heading: 'Tozalandi', text: data.message, icon: 'success'});
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        throw new Error(data.message || 'Xato');
                    }
                })
                .catch(err => {
                    $.toast({heading: 'Xato', text: err.message, icon: 'error'});
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = originalHTML;
                });
        });

        // === TALABALARNING TOZALASH TUGMASI ===
        document.getElementById('clear-students-btn').addEventListener('click', function () {
            if (!confirm('Barcha talabalar oâ€˜chiriladi. Davom etasizmi?')) return;

            const originalHTML = this.innerHTML;
            this.disabled = true;
            this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Oâ€˜chirilmoqda...';

            fetch('/users/clear-students/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        $.toast({heading: 'Tozalandi', text: data.message, icon: 'success'});
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        throw new Error(data.message || 'Xato');
                    }
                })
                .catch(err => {
                    $.toast({heading: 'Xato', text: err.message, icon: 'error'});
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = originalHTML;
                });
        });
    });
</script>
{% endblock scripts %}

