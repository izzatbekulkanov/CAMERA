{% extends 'base/base.html' %}
{% load static %}

{% block title %}Bugungi Davomat – NamDPI{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    {% include 'includes/breadcrumbs.html' with breadcrumbs=breadcrumbs %}

    <!-- Asosiy card – oq fon, ko‘k emas -->
    <div class="card border-0 shadow">
        <div class="card-header bg-white border-bottom py-3">
            <h5 class="mb-0  text-muted fw-bold d-flex align-items-center justify-content-between">
                <span>Bugungi Davomat • {{ today|date:"d F Y" }}</span>
                <small class="text-muted">Jami: {{ attendances.count }} nafar</small>
            </h5>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="text-center" style="width:40px;">#</th>
                        <th style="width:70px;"></th>
                        <th>F.I.O</th>
                        <th>Kirish</th>
                        <th>Chiqish</th>
                        <th>Oxirgi ko‘rilgan</th>
                        <th>Hozirda</th>
                        <th>Vaqt (daq)</th>
                        <th>Rasmlar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for att in attendances %}
                    <tr>
                        <td class="text-center small text-muted">{{ forloop.counter }}</td>
                        <td>
                            <img src="{% if att.user.image %}{{ att.user.image.url }}{% else %}{% static 'assets/images/users/default-avatar.png' %}{% endif %}"
                                 class="rounded-circle shadow-sm" width="44" height="44" style="object-fit: cover;">
                        </td>
                        <td class="fw-semibold">{{ att.user.full_name|default:att.user.username }}</td>

                        <td class="text-center">
                            {% if att.entry_time %}
                                <span class="badge bg-success">{{ att.entry_time|time:"H:i" }}</span>
                            {% else %}–{% endif %}
                        </td>
                        <td class="text-center">
                            {% if att.exit_time %}
                                <span class="badge bg-danger">{{ att.exit_time|time:"H:i" }}</span>
                            {% else %}–{% endif %}
                        </td>
                        <td class="text-center small text-muted">
                            {{ att.last_seen|time:"H:i:s" }}
                        </td>
                        <td class="text-center">
                            {% if att.is_present %}
                                <span class="text-success fw-bold">Aktiv</span>
                            {% else %}
                                <span class="text-danger">Chiqdi</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <strong class="text-primary">{{ att.duration_minutes|default:"0" }}</strong>
                        </td>

                        <!-- Rasmlar stack – faqat modal ochadi, lightbox yo‘q -->
                        <td class="text-center">
                            {% if att.photos.all %}
                                <div class="d-inline-flex position-relative">
                                    {% for photo in att.photos.all|slice:":4" %}
                                        <img src="{{ photo.image.url }}"
                                             class="border border-white shadow-sm rounded"
                                             width="38" height="38"
                                             style="margin-left: -12px; object-fit: cover; cursor: pointer;{% if forloop.counter0 == 0 %}margin-left: 0;{% endif %}"
                                             data-bs-toggle="modal"
                                             data-bs-target="#photoModal{{ forloop.parentloop.counter }}">
                                    {% endfor %}
                                    {% if att.photos.all|length > 4 %}
                                        <span class="position-absolute top-50 start-100 translate-middle bg-dark text-white rounded-pill px-2 small fw-bold shadow"
                                              style="font-size: 10px; margin-left: -10px; z-index: 5;">
                                            +{{ att.photos.all|length|add:"-4" }}
                                        </span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span class="text-muted small">–</span>
                            {% endif %}
                        </td>
                    </tr>

                    <!-- Modal – faqat kattaroq rasm, lightbox yo‘q -->
                    <div class="modal fade" id="photoModal{{ forloop.counter }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-xl">
                            <div class="modal-content border-0 shadow-lg">
                                <div class="modal-header border-0 pb-2">
                                    <h5 class="modal-title d-flex align-items-center">
                                        <img src="{% if att.user.image %}{{ att.user.image.url }}{% else %}{% static 'assets/images/users/default-avatar.png' %}{% endif %}"
                                             class="rounded-circle me-3" width="44" height="44">
                                        <div>
                                            <div class="fw-bold">{{ att.user.full_name }}</div>
                                            <small class="text-muted">Bugungi suratlar • {{ today|date:"d.m.Y" }}</small>
                                        </div>
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body py-4">
                                    <div class="row g-4 justify-content-center">
                                        {% for photo in att.photos.all %}
                                        <div class="col-6 col-md-4 col-lg-3">
                                            <img src="{{ photo.image.url }}"
                                                 class="img-fluid rounded shadow-sm border"
                                                 style="height: 220px; object-fit: cover; width: 100%; cursor: default;"
                                                 alt="Surat {{ forloop.counter }}">
                                            <div class="text-center mt-2 small text-muted">
                                                {{ photo.captured_at|time:"H:i:s" }}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% if att.photos.all|length == 0 %}
                                        <div class="text-center text-muted py-5">
                                            <i class="fas fa-image fa-3x mb-3 opacity-25"></i><br>
                                            Surat topilmadi
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="modal-footer border-0 justify-content-center">
                                    <small class="text-muted">NamDPI • AI Yuzni tanish tizimi</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center py-5 text-muted">
                            <i class="fas fa-building fa-3x mb-3 opacity-25"></i><br>
                            Bugun hech kim binoda yo‘q
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}


<script>
// Hover effekti (ixtiyoriy)
document.querySelectorAll('img[style*="margin-left: -12px"]').forEach(img => {
    img.addEventListener('mouseenter', () => img.style.transform = 'translateY(-3px)');
    img.addEventListener('mouseleave', () => img.style.transform = 'translateY(0)');
});
</script>
{% endblock %}